import fs from 'fs';
import ejs from 'ejs';
import jsBeautify from 'js-beautify';

const { html: beautify } = jsBeautify;

/**
 * @param {string} configFile
 *   Relative path to style-guide configuration file (e.g. "style-guide/config.json").
 * @returns {object}
 */
function getConfig(configFile) {
  try {
    const json = fs.readFileSync(configFile);
    return JSON.parse(json);
  } catch (e) {
    console.error(`Unable to read or parse "${configFile}"`);
    throw e;
  }
}

/**
 * @param {object} tokens
 *   Style Dictionary's "dictionary.tokens"
 * @param {string} targetPath
 *   Represents the group of tokens to display together.
 *   Dot-notation key path, e.g. "color.primary".
 * @param {string[]} orderOverride
 *   Array of token keys to define the order of a group.
 *   E.g. ["base", "10", "20"]
 *   Why? In some cases, the list of tokens generated by a formatter will not
 *   match their original order. This happens because the order of object keys
 *   are not guaranteed in JavaScript.
 * @returns {object[]} List of Style Dictionary tokens
 */
function getTokenGroup(tokens, targetPath, orderOverride = []) {
  let tokenGroup;

  try {
    // console.log('targetPath', targetPath);
    // console.log('tokenGroup', targetPath, targetPath.split(".").reduce((o, k) => o[k], tokens));
    tokenGroup = targetPath.split(".").reduce((o, k) => o[k], tokens);
  } catch (e) {
    console.log(`Token path "${targetPath}" does not exist`);
    throw e;
  }

  if (orderOverride.length) {
    return orderOverride.map((key) => tokenGroup[key]);
  }

  return Object.values(tokenGroup);
}

/**
 * @param {object} config
 *   The config object to inject tokens into.
 * @param {object} tokens
 *   Style Dictionary's "dictionary.tokens"
 */
function addTokensToConfig(config, tokens) {
  config.sections.forEach((section) => {
    section.groups.forEach((group) => {
      // Add SD tokens to config object
      group.tokens = getTokenGroup(
          tokens,
          group.tokensPath,
          group.order
      );
    });
  });
}

export default {
  name: "styleguide/static",
  format: async function ({
    dictionary,
    options
  }) {
    const {tokens} = dictionary;
    const {templatesFolder, configFile} = options;

    const config = getConfig(configFile);
    addTokensToConfig(config, tokens);

    const indexTemplate = fs.readFileSync(`${templatesFolder}layout/index.ejs`, 'utf8');

    // console.log(config.sections[0].groups[0].tokens[0].original);

    const html = ejs.render(indexTemplate, { config }, {
      root: templatesFolder,
    });

    return beautify(html, { 'max_preserve_newlines': '-1' });
  }
};
